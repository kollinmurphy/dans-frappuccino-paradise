---
import Layout from "@layouts/Layout.astro";
import { authenticate } from "@utils/auth";
import db from "@database";
import UnfulfilledOrders from "@components/UnfulfilledOrders";
import HoursLog from "@components/HoursLog";
import type { Order as OrderModel } from "@data/types/order";
import type { Hours as HoursModel } from "@data/types/hours";


const account = authenticate(Astro.cookies)

const orders = await db.Order.findAll({
  where: {
    status: 'purchased',
  },
  order: [["createdAt", "ASC"]],
  include: [
    {
      model: db.OrderProduct,
      include: [
        db.Product,
        {
          model: db.OrderProductIngredient,
          include: [
            {
              model: db.Ingredient,
            },
          ],
        },
      ],
    },
  ],
});

const hours = await db.Hours.findAll({
  order: [["createdAt", "ASC"]],
  include: [
    {
      model: db.Hours,
    },
  ],
});

if (!account || account.role === 'user')
  return Astro.redirect('/404')
---

<Layout title='Employee'>
  <HoursLog client:idle hours={hours.map(o => o.get({ plain: true })) as unknown as Array<HoursModel>} />
  <UnfulfilledOrders client:idle orders={orders.map(o => o.get({ plain: true })) as unknown as Array<OrderModel>} />
</Layout>
